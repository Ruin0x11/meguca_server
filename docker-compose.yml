version: '3'
services:
    registry:
      image: registry:2
      restart: always
      volumes:
          - "/var/lib/registry:/var/lib/registry"
      ports:
        - "5000:5000"
    dnsmasq:
        build: ./dnsmasq
        cap_add:
            - NET_ADMIN
        network_mode: host
        command: --address=/meguca.moe/192.168.0.100
        ports:
            - "53:53"
        volumes:
            - "./dnsmasq/conf:/etc/dnsmasq"
        restart: always

    nginx-proxy:
        image: jwilder/nginx-proxy
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - /var/run/docker.sock:/tmp/docker.sock:ro
            - /etc/nginx/vhost.d
            - /usr/share/nginx/html
    whoami:
        image: jwilder/whoami
        environment:
            - VIRTUAL_HOST=whoami.meguca.moe
    jenkins:
        build: ./blueocean
        depends_on:
            - registry
        user: "1001"
        expose:
            - "8080"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /var/lib/jenkins:/var/jenkins_home
        environment:
            - VIRTUAL_HOST=aoiumi.meguca.moe
            - VIRTUAL_PORT=8080
